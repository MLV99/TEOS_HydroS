---
title: "TEOS Hydrostation S Data Lab"
author: "Mileisha L. VelÃ¡zquez"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: tactile
    highlight: vignette
    
    
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
### Load required libraries
```{r,  include=TRUE, echo=TRUE, warning=FALSE, message=FALSE}
library(tidyverse)
library(gsw)
```
## Import Data: 

Names of columns are separated by commas and white spaces, meanwhile the observations within the rows are separated by only white spaces. This requires rearranging data so that the we may view both the data with the correct column names 


```{r, include=TRUE, echo=TRUE, warning=FALSE, results='asis', message= FALSE }

hydrostation_bottle <- read_delim("hydrostation_bottle.txt", 
    delim = "\t", escape_double = FALSE, 
    trim_ws = TRUE, skip = 31)


hydrostation_bottle_names <- read_csv("hydrostation_bottle.txt", 
    skip = 30)

colnames(hydrostation_bottle)=colnames(hydrostation_bottle_names)

```

# Variable Names and Units: 
```
yyyymmdd = Year Month Day   
decy   = Decimal Year     
time   = Time (hhmm)      
latN   = Latitude (Deg N) 
lonW   = Longitude (Deg W)
Depth  = Depth (m)                  
Temp   = Temperature ITS-90 (C) 
Pres   = CTD Pressure (dbar)   
CTD_S  = CTD Salinity (PSS-78)      
Sal1   = Salinity-1 (PSS-78)        
Sig-th = Sigma-Theta (kg/m^3)       
O2(1)  = Oxygen-1 (umol/kg)          
OxFixT = Oxygen Fix Temp (C)        
Anom1  = Oxy Anomaly-1 (umol/kg)    
// Quality flags //
-999  = No data
 0 = Less than detection limit
```

## Plots: 
```{r, fig.cap= "Figure 1. Clear seasonal signal is observed for sigma-theta" }

hydrostation_bottle %>% 
  filter(`Sig-th` !=-999 & Depth <20) %>% #filter out -999, no data flag and depth for better visual
  ggplot()+geom_line(aes(x=decy,y=`Sig-th`)) #use to visualize patter in data 
```
```{r, fig.cap=" Figure 2. Relationship between temperature and density. Both are strongly correlated"}
hydrostation_bottle %>% 
  filter(`Sig-th` !=-999 & Depth <20) %>% 
  #filter out -999, no data flag and depth for better visual
  ggplot()+geom_point(aes(x=Temp,y=`Sig-th`))#there are two outliers
```

### What to consider 
- Density data from 1988-present, but salinity data from 1950s-present 

- Calculate seawater density form 1950s - present

- TEOS-10 usage for this procedure 


## TEOS-10 Toolbox in Packag seacarb 
```{r}
#gsw
#gsw_sigma0
 #requires SA (absolute salinity) and CT (conservative temperature)

#gsw_SA_from_SP
#sea pressure in (dbar), log, lat, practical sal
```


```{r}
#Pressure plot missing points
hydrostation_bottle %>% 
  ggplot()+
  geom_point(aes(x=decy, y=Pres))
```



```{r}
#Depth data for all time series data 
hydrostation_bottle %>% 
  ggplot()+
  geom_point(aes(x=decy, y=Depth))
```

## Calculate Sea Pressure from Depth Using GSW Function

```{r, message=FALSE, warning=FALSE}
hydrostation_bottle=
  hydrostation_bottle %>% 
mutate(Pres_gsw=gsw_p_from_z(Depth*-1,latN))

#Check new variable in plot
hydrostation_bottle %>% 
  ggplot()+
#strong 1:1 agreement between measured pressure and calculated pressure
  geom_point(aes(x=Pres, y=Pres_gsw))
```

## Calculate Absolue Salinity from Practical Salinity
```{r, warning=FALSE}
hydrostation_bottle %>% 
  ggplot()+
  geom_point(aes(x=decy, y=Sal1))

hydrostation_bottle=
  hydrostation_bottle %>% 
mutate(Pres_gsw=gsw_p_from_z(Depth*-1,latN)) %>% 
  mutate(S_abs_gsw=gsw_SA_from_SP(Sal1,Pres_gsw, 360-lonW, latN))

#Check
hydrostation_bottle %>% 
  ggplot()+
  geom_point(aes(x=decy, y=S_abs_gsw))

#Another way to check 
hydrostation_bottle %>% 
  filter(Sal1!= -999) %>% 
  ggplot()+
  geom_point(aes(x=Sal1, y=S_abs_gsw))
```

## Calculate Conservative Temperature 

```{r}
#gsw_CT_from_t
#absolute salinity , in situ temp (ITS-90), & sea pressure 

#Add line to calculate CT 
hydrostation_bottle=
  hydrostation_bottle %>% 
  filter(Sal1!=-999) %>%
mutate(Pres_gsw=gsw_p_from_z(Depth*-1,latN)) %>% 
  mutate(S_abs_gsw=gsw_SA_from_SP(Sal1,Pres_gsw, 360-lonW, latN)) %>% 
  mutate(T_cons_gsw=gsw_CT_from_t(S_abs_gsw, Temp, Pres_gsw))
   
#Check data
  hydrostation_bottle %>%
  filter(Sal1!=-999) %>% 
  ggplot()+
  geom_point(aes(x=Temp, y=T_cons_gsw))
  
  
```

```{r}
#Still missing data 
  hydrostation_bottle=
  hydrostation_bottle %>% 
  filter(Sal1!=-999) %>%
    filter(Temp!=-999) %>% 
mutate(Pres_gsw=gsw_p_from_z(Depth*-1,latN)) %>% 
  mutate(S_abs_gsw=gsw_SA_from_SP(Sal1,Pres_gsw, 360-lonW, latN)) %>% 
  mutate(T_cons_gsw=gsw_CT_from_t(S_abs_gsw, Temp, Pres_gsw))
  
  #Check again
  hydrostation_bottle %>%
  filter(Sal1!=-999) %>%
   filter(Temp!=-999) %>% 
  ggplot()+
  geom_point(aes(x=Temp, y=T_cons_gsw))
```


## Finally Calculate Sigma-theta: requires SA (absolute salinity) and CT (conservative temperature)
```{r}
#FOR HW 
  HydroS=
  hydrostation_bottle=
  hydrostation_bottle %>% 
  filter(Sal1!=-999) %>%
    filter(Temp!=-999) %>% 
  #calculate pressure
mutate(Pres_gsw=gsw_p_from_z(Depth*-1,latN)) %>% 
  #calc. absolute salinity
  mutate(S_abs_gsw=gsw_SA_from_SP(Sal1,Pres_gsw, 360-lonW, latN)) %>% 
  #calc.conservative temperature
  mutate(T_cons_gsw=gsw_CT_from_t(S_abs_gsw, Temp, Pres_gsw)) %>% 
  #calc. sigma-theta
  mutate(Sig_th_gsw=gsw_sigma0(S_abs_gsw,T_cons_gsw))

HydroS %>% 
  filter(`Sig-th`!=-999) %>% 
  ggplot()+
  geom_point(aes(x=`Sig-th`, y=Sig_th_gsw))
```


### Identify and Fix Error: 

```{r}
HydroS %>% #Low sig-th-gsw point
  filter(Sig_th_gsw<0)
 #Sal1 too low, caused low sig-th-gsw calculation 

#Calculate Sig-th-gsw with CTD_S instead of Sal1 for outlier point 
HydroS_correctedS_a=  
HydroS %>% 
filter(Sig_th_gsw<0) %>% 
  mutate(S_abs_gsw=gsw_SA_from_SP(CTD_S,Pres_gsw, 360-lonW, latN)) %>% 
  mutate(T_cons_gsw=gsw_CT_from_t(S_abs_gsw, Temp, Pres_gsw)) %>% 
  mutate(Sig_th_gsw=gsw_sigma0(S_abs_gsw,T_cons_gsw))
  
HydroS_correctedS_b=  
HydroS %>% 
filter(Sig_th_gsw>0)

HydroS_corrected = rbind(HydroS_correctedS_a, HydroS_correctedS_b)
HydroS_corrected %>% 
  filter(`Sig-th`!=-999) %>% 
  ggplot()+
  geom_point(aes(x=`Sig-th`, y=Sig_th_gsw))
```


```{r}

HydroS_corrected %>% 
  
  ggplot()+

  geom_point(aes(x=Sig_th_gsw,y=Depth))+

  scale_y_reverse()+

  scale_x_continuous(position="top")+

  xlab(expression(paste(sigma[theta]," (kg m"^"-3",")")))+

  ylab("Depth (m)")+

  theme_classic()
```

## Linear Models - Has surface sigma theta decreased over time? 

```{r}
HydroS_shallow = HydroS_corrected %>% 

                 filter(Depth<30)#shallow 

?lm #linear models

#lm(y~x,data=data)

lm(Sig_th_gsw~decy,data=HydroS_shallow)
#lm(formula, data)
#response~terms -> Y~X

#y=mx+b

#y = Sig_th_gsw

#x = decy

#coefficients: intercept = b, decy = m

#Sig_th_gsw = -0.004*decy + 33.4

#(kg/m^3) = (kg/m^3/y)*y + (kg/m^3)

sig_theta_time_model=lm(Sig_th_gsw~decy,data=HydroS_shallow)

summary(sig_theta_time_model)
```

## Plotly - Interactive Plot for HydroS_shallow data

```{r, message =FALSE, warning = FALSE}
library(plotly)

plot=HydroS_shallow %>% 

  ggplot(aes(x=decy,y=Sig_th_gsw))+

  geom_point()+

  geom_line()+

  geom_smooth(method="lm")+
#aids in overplotting visualization 
  
  theme_classic()

ggplotly(plot)
```

Sigma theta values do change over time. The regression line slightly decreases from 1960 to 2020





## Seanonal Variability of Sigma-Theta Values Plot 

Winter months in Bermuda: December - March, while summer months are from August through October. 

```{r, warning= FALSE}
HydroS_seasons=
  HydroS_corrected %>% 
  mutate(month=as.numeric(substr(yyyymmd, 5, 6 ))) %>% 
mutate(season=ifelse(month==12|| month==1| month==2| month==3, 'winter',
                               ifelse(month==8|month==9|month==10,'summer','')))

summary(lm(`O2(1)`~season,data=HydroS_seasons))
```

Questions: 

- Is dissolved O2 higher in summer than winter? 
- Is salinity higher in summer than winter?
- Is sound speed higher?


# Lab Assignment 

1. Pick a question (include hypothesis)
  
  - Q: How does temperature and salinity co-vary over time?
  - H: As time passes, both temperature and salinity parameters will experience variability. 
  
  
2. Produce a plot and a statistical summary using lm()
3. Describe your results, the summary, and answer the question
4. Compile into a completed lab report using R Markdown


## Q: How does temperature and salinity co-vary over time? 

### Temperature variability over time 
Code:

```{r, warning=FALSE} 
HydroS_shallow=
  HydroS_corrected %>% 
  filter(Depth<50) 

HydroS_shallow %>% 
  ggplot(aes(x=decy, y=T_cons_gsw))+
  geom_line()+
  geom_smooth(method=lm, color = "red")+
  xlab('Year')+
  ylab('Temperature (C)')+
theme_classic()
```

## Applied linear model regression

```{r}
lm(T_cons_gsw~decy,data=HydroS_shallow)
temp_time_model=lm(T_cons_gsw~decy,data=HydroS_shallow)

summary(temp_time_model)

```

### Salinity variability over time 
Code:
```{r}
HydroS_shallow %>% 
  ggplot(aes(x=decy, y=S_abs_gsw))+
  geom_line()+
   geom_smooth(method=lm, color = "red")+
  xlab('Year')+
  ylab('Salinity')+
theme_classic()

```

## Applied linear model regression
```{r}
sal_time_model=lm(S_abs_gsw~decy,data=HydroS_shallow)
summary(sal_time_model)
```

## Discussion - Temperature and Salinity Variability Over Time 

Overall, both measured variables of temperature and salinity collected from Hydrostation S increase in shallow waters above 50 meters over time (1960 - 2020). To observe the relationship of temperature vs time and salinity vs time, the data required a linear model transformation. For this, the lm function R was applied. As a result, residual analysis and statistical summaries were generated for establishing a linear relationship of the plotted variables. However, there are observed differences in the slope and therefore the overall relationship between the studied parameters. The regression line exerted for the temperature variability in shallow depths is steeper than the line denoted for salinity variability. Consequently, we can debate that temperature has a stronger relationship and therefore presents greater change over time.   

